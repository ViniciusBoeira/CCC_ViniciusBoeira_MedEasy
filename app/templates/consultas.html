{% extends "base.html" %}

{% block app_content %}
    <div class="row">
        {# Centraliza o conteúdo em 10 colunas #}
        <div class="col-md-10 col-md-offset-1">

            <div class="panel panel-primary">
                <div class="panel-heading text-center">
                    <i class="fa fa-calendar fa-lg" aria-hidden="true"></i> {{ title }}
                </div>
                <div class="panel-body">

                    {% if consultas %}
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Data e Hora</th>
                                {% if g.user.user_type == 'paciente' %}
                                    <th scope="col">Médico</th>
                                {% else %}
                                    <th scope="col">Paciente</th>
                                {% endif %}
                                <th scope="col">Status</th>
                                <th scope="col" class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for consulta in consultas %}
                            <tr>
                                <td>{{ consulta.data_hora.strftime('%d/%m/%Y às %H:%M') }}</td>
                                {% if g.user.user_type == 'paciente' %}
                                    <td>Dr(a). {{ consulta.medico.name }} ({{ consulta.medico.especialidade }})</td>
                                {% else %}
                                    <td>{{ consulta.paciente.name }}</td>
                                {% endif %}
                                <td>
                                    {# Lógica de Labels (cores) #}
                                    {% if consulta.status == 'Agendada' %}
                                        <span class="label label-primary">{{ consulta.status }}</span>
                                    {% elif consulta.status == 'Confirmada' %}
                                        <span class="label label-success label-em-aberto">Em aberto</span>
                                    {% elif consulta.status == 'Finalizada' %}
                                        <span class="label label-success label-finalizada">Finalizada</span>
                                    {% elif consulta.status == 'Cancelada' %}
                                        <span class="label label-danger">{{ consulta.status }}</span>
                                    {% else %}
                                        <span class="label label-default">{{ consulta.status }}</span>
                                    {% endif %}
                                </td>
                                
                                {# APLICANDO WHITE-SPACE: NOWRAP AQUI #}
                                <td class="text-center" style="white-space: nowrap;">
                                    {% if g.user.user_type == 'medico' %}
                                        {% if consulta.status == 'Agendada' %}
                                        <form action="{{ url_for('confirmar_consulta', consulta_id=consulta.id) }}" method="POST" style="display: inline;">
                                            {{ form.hidden_tag() }}
                                            <button type="submit" class="btn btn-xs btn-success" title="Confirmar Presença">Confirmar</button>
                                        </form>
                                        {% endif %}
                                        
                                        {# Mostra o botão Prontuário para consultas Confirmadas E Finalizadas #}
                                        {% if consulta.status == 'Confirmada' or consulta.status == 'Finalizada' %}
                                        <a href="{{ url_for('gerenciar_evolucoes', consulta_id=consulta.id) }}" class="btn btn-xs btn-primary" title="Acessar Prontuário">Prontuário</a>
                                        {% endif %}

                                        {% if consulta.status == 'Confirmada' %}
                                        <form action="{{ url_for('finalizar_consulta', consulta_id=consulta.id) }}" method="POST" style="display: inline;">
                                            {{ form.hidden_tag() }}
                                            <button type="submit" class="btn btn-xs btn-warning" title="Finalizar Atendimento">Finalizar</button>
                                        </form>
                                        {% endif %}
                                    {% endif %}

                                    {# Mostra o botão Ver Histórico para consultas Confirmadas E Finalizadas (apenas pacientes) #}
                                    {% if g.user.user_type == 'paciente' and (consulta.status == 'Confirmada' or consulta.status == 'Finalizada') %}
                                        <a href="{{ url_for('historico_consulta', consulta_id=consulta.id) }}" class="btn btn-xs btn-info" title="Ver Evoluções e Receitas">Ver Histórico</a>
                                    {% endif %}

                                    {# Ações de Cancelar e Editar (se não estiverem Cancelada ou Finalizada) #}
                                    {% if consulta.status != 'Cancelada' and consulta.status != 'Finalizada' %}
                                    <form action="{{ url_for('cancelar_consulta', consulta_id=consulta.id) }}" method="POST" style="display: inline;">
                                        {{ form.hidden_tag() }}
                                        <button type="submit" class="btn btn-xs btn-danger" title="Cancelar Consulta">Cancelar</button>
                                    </form>
                                    <a href="{{ url_for('editar_consulta', consulta_id=consulta.id) }}" class="btn btn-xs btn-default" title="Reagendar/Alterar">Editar</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fa fa-info-circle" aria-hidden="true"></i> Nenhuma consulta encontrada para o seu perfil.
                        </div>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
{% endblock %}