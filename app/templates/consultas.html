{% extends "base.html" %}

{% block app_content %}
    <h2>{{ title }}</h2>

    {% if consultas %}
    <table class="table table-striped">
        <thead>
            <tr>
                <th scope="col">Data e Hora</th>
                {% if g.user.user_type == 'paciente' %}
                    <th scope="col">Médico</th>
                {% else %}
                    <th scope="col">Paciente</th>
                {% endif %}
                <th scope="col">Status</th>
                <th scope="col">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for consulta in consultas %}
            <tr>
                <td>{{ consulta.data_hora.strftime('%d/%m/%Y às %H:%M') }}</td>
                {% if g.user.user_type == 'paciente' %}
                    <td>Dr(a). {{ consulta.medico.name }} ({{ consulta.medico.especialidade }})</td>
                {% else %}
                    <td>{{ consulta.paciente.name }}</td>
                {% endif %}
                <td>
                    {% if consulta.status == 'Agendada' %}
                        <span class="label label-primary">{{ consulta.status }}</span>
                    {% elif consulta.status == 'Confirmada' %}
                        <span class="label label-success">{{ consulta.status }}</span>
                    {% elif consulta.status == 'Finalizada' %}
                        <span class="label label-default">{{ consulta.status }}</span>
                    {% elif consulta.status == 'Cancelada' %}
                        <span class="label label-danger">{{ consulta.status }}</span>
                    {% else %}
                        <span class="label label-default">{{ consulta.status }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if g.user.user_type == 'medico' %}
                        {% if consulta.status == 'Agendada' %}
                        <form action="{{ url_for('confirmar_consulta', consulta_id=consulta.id) }}" method="POST" style="display: inline;">
                            {{ form.hidden_tag() }}
                            <button type="submit" class="btn btn-xs btn-success">Confirmar</button>
                        </form>
                        {% endif %}
                        
                        {# CORREÇÃO: Mostra o botão Prontuário para consultas Confirmadas E Finalizadas #}
                        {% if consulta.status == 'Confirmada' or consulta.status == 'Finalizada' %}
                        <a href="{{ url_for('gerenciar_evolucoes', consulta_id=consulta.id) }}" class="btn btn-xs btn-primary">Prontuário</a>
                        {% endif %}

                        {% if consulta.status == 'Confirmada' %}
                        <form action="{{ url_for('finalizar_consulta', consulta_id=consulta.id) }}" method="POST" style="display: inline;">
                            {{ form.hidden_tag() }}
                            <button type="submit" class="btn btn-xs btn-warning">Finalizar</button>
                        </form>
                        {% endif %}
                    {% endif %}

                    {# CORREÇÃO: Mostra o botão Ver Histórico para consultas Confirmadas E Finalizadas #}
                    {% if g.user.user_type == 'paciente' and (consulta.status == 'Confirmada' or consulta.status == 'Finalizada') %}
                        <a href="{{ url_for('historico_consulta', consulta_id=consulta.id) }}" class="btn btn-xs btn-info">Ver Histórico</a>
                    {% endif %}

                    {% if consulta.status != 'Cancelada' and consulta.status != 'Finalizada' %}
                    <form action="{{ url_for('cancelar_consulta', consulta_id=consulta.id) }}" method="POST" style="display: inline;">
                        {{ form.hidden_tag() }}
                        <button type="submit" class="btn btn-xs btn-danger">Cancelar</button>
                    </form>
                    <a href="{{ url_for('editar_consulta', consulta_id=consulta.id) }}" class="btn btn-xs btn-default">Editar</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>Nenhuma consulta encontrada.</p>
    {% endif %}

{% endblock %}